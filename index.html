<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sondhi Point System | Executive</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

    <div id="dashboard">
        <header class="main-header">
            <div class="header-container">
                <div>
                    <h1 class="brand-name">Sondhi Point System</h1>
                    <p class="brand-subtitle">Luxury Terminal</p>
                </div>
                <div class="action-buttons">
                    <button onclick="toggleBulk()" class="btn-secondary">ðŸ“¢ Broadcast</button>
                    <button onclick="toggleModal()" class="btn-primary">+ New Member</button>
                </div>
            </div>
        </header>

        <main class="content">
            <div class="search-container">
                <input id="searchBar" onkeyup="render()" type="text" placeholder="Search customer name or phone...">
            </div>
            <div id="customerGrid" class="grid"></div>
        </main>
    </div>

    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content wide">
            <h2 id="histName" class="gold-text">Activity Log</h2>
            <div class="history-list" id="historyContainer"></div>
            <button onclick="closeHistory()" class="btn-primary full-width">Back to Dashboard</button>
        </div>
    </div>

    <div id="bulkModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="gold-text">Bulk Broadcast</h2>
            <select id="bulkTier" onchange="countTierMembers()">
                <option value="All">All Members</option>
                <option value="Silver">Silver</option>
                <option value="Gold">Gold</option>
                <option value="Platinum">Platinum</option>
            </select>
            <p id="tierCountDisplay" class="count-info"></p>
            <textarea id="bulkMsg" rows="4" placeholder="Your gold-tier message..."></textarea>
            <button onclick="startBulkSend()" class="btn-primary full-width">Send WhatsApp</button>
            <button onclick="toggleBulk()" class="btn-text">Cancel</button>
        </div>
    </div>

    <div id="regModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="gold-text">Register Member</h2>
            <input id="nName" type="text" placeholder="Full Name">
            <input id="nPhone" type="text" placeholder="Phone Number (with Country Code)">
            <button onclick="addCust()" class="btn-primary full-width">Activate Membership</button>
            <button onclick="toggleModal()" class="btn-text">Cancel</button>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('sondhi_v14')) || [];

        function getTier(totalPts) {
            if (totalPts >= 2000) return { n: 'Platinum', c: 'tier-platinum' };
            if (totalPts >= 1000) return { n: 'Gold', c: 'tier-gold' };
            return { n: 'Silver', c: 'tier-silver' };
        }

        function toggleModal() { document.getElementById('regModal').classList.toggle('hidden'); }
        function toggleBulk() { document.getElementById('bulkModal').classList.toggle('hidden'); countTierMembers(); }
        
        function addCust() {
            const n = document.getElementById('nName').value;
            const p = document.getElementById('nPhone').value;
            if(n && p) {
                db.push({name: n, phone: p, pts: 0, totalEarned: 0, history: [{date: new Date().toLocaleString(), type: 'Account Opened', amt: 0}]});
                render(); toggleModal();
                document.getElementById('nName').value = '';
                document.getElementById('nPhone').value = '';
            }
        }

        function updatePoints(index, amt) {
            db[index].pts += amt;
            if(amt > 0) db[index].totalEarned += amt;
            db[index].history.push({
                date: new Date().toLocaleString(),
                type: amt > 0 ? 'Credit' : 'Redemption',
                amt: amt
            });
            render();
        }

        function showHistory(i) {
            const u = db[i];
            document.getElementById('histName').innerText = u.name + "'s History";
            const container = document.getElementById('historyContainer');
            container.innerHTML = u.history.slice().reverse().map(h => `
                <div class="history-item">
                    <span>${h.date} <br><small>${h.type}</small></span>
                    <span class="${h.amt >= 0 ? 'text-gold' : 'text-red'}">${h.amt > 0 ? '+' : ''}${h.amt}</span>
                </div>
            `).join('');
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function closeHistory() { document.getElementById('historyModal').classList.add('hidden'); }

        function render() {
            const grid = document.getElementById('customerGrid');
            const q = document.getElementById('searchBar').value.toLowerCase();
            grid.innerHTML = '';
            db.forEach((u, i) => {
                if(u.name.toLowerCase().includes(q) || u.phone.includes(q)) {
                    const t = getTier(u.totalEarned || 0);
                    grid.innerHTML += `
                        <div class="card">
                            <div class="card-header">
                                <span class="tier-badge ${t.c}">${t.n}</span>
                                <button onclick="showHistory(${i})" class="btn-mini">ðŸ“œ Log</button>
                            </div>
                            <h3>${u.name}</h3>
                            <p class="phone">${u.phone}</p>
                            <div class="stats">
                                <div><small>WALLET</small><p>${u.pts}</p></div>
                                <div><small>LIFETIME</small><p>${u.totalEarned}</p></div>
                            </div>
                            <div class="card-actions">
                                <button onclick="updatePoints(${i}, 100)" class="btn-action">+100</button>
                                <button onclick="updatePoints(${i}, 500)" class="btn-action">+500</button>
                                <button onclick="updatePoints(${i}, -100)" class="btn-action redeem">Redeem 100</button>
                            </div>
                        </div>
                    `;
                }
            });
            localStorage.setItem('sondhi_v14', JSON.stringify(db));
        }

        function countTierMembers() {
            const selected = document.getElementById('bulkTier').value;
            let count = (selected === "All") ? db.length : db.filter(u => getTier(u.totalEarned).n === selected).length;
            document.getElementById('tierCountDisplay').innerText = `${count} members in this segment.`;
        }

        function startBulkSend() {
            const selected = document.getElementById('bulkTier').value;
            const message = document.getElementById('bulkMsg').value;
            if(!message) return alert("Please enter a message.");
            const targets = (selected === "All") ? db : db.filter(u => getTier(u.totalEarned).n === selected);
            targets.forEach((u, i) => {
                setTimeout(() => {
                    window.open(`https://wa.me/${u.phone}?text=${encodeURIComponent("Hi " + u.name + "! " + message)}`, '_blank');
                }, i * 1500);
            });
        }

        render();
    </script>
</body>
</html>
