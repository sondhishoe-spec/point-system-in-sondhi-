<script>
    let db = JSON.parse(localStorage.getItem('sondhi_v23')) || [];
    let activeIdx = null;

    function render() {
        const grid = document.getElementById('customerGrid');
        const q = document.getElementById('searchBar').value.toLowerCase();
        grid.innerHTML = '';
        db.forEach((u, i) => {
            if(u.name.toLowerCase().includes(q) || u.phone.includes(q)) {
                const t = getTier(u.totalEarned);
                grid.innerHTML += `<div class="card" onclick="openProfile(${i})">
                    <div class="card-header"><span class="tier-badge ${t.c}">${t.n}</span><span style="color:#444; font-size:10px;">ID: ${i+1}</span></div>
                    <h3>${u.name}</h3>
                    <div class="stats"><div><small>POINTS</small><p>${u.pts.toFixed(0)}</p></div>
                    <button onclick="openTrans(${i}, event)" class="btn-mini">üí∞ PURCHASE</button></div></div>`;
            }
        });
        localStorage.setItem('sondhi_v23', JSON.stringify(db));
    }

    function openProfile(i) {
        activeIdx = i; const u = db[i]; const t = getTier(u.totalEarned);
        document.getElementById('pName').innerText = u.name;
        document.getElementById('pAvatar').innerText = u.name[0].toUpperCase();
        document.getElementById('pPhone').innerText = u.phone;
        document.getElementById('pPoints').innerText = u.pts.toFixed(0);
        document.getElementById('pSpent').innerText = (u.totalSpent || 0).toLocaleString();
        document.getElementById('pTier').className = `tier-badge ${t.c}`;
        document.getElementById('pTier').innerText = t.n;

        const statusDiv = document.getElementById('rewardStatus');
        const actionDiv = document.getElementById('redeemAction');

        // UPDATED REDEMPTION LOGIC: SUBTRACT COST, KEEP REMAINDER
        if (u.pts >= 1500) {
            statusDiv.innerHTML = `<p style="color:var(--gold); font-size:13px;">‚úÖ <b>Level 2:</b> 10% Discount (Cost: 1500 pts)</p>`;
            actionDiv.innerHTML = `
                <button onclick="confirmRedeem(1500, '10%')" class="btn-primary full-width">Redeem 1500 pts</button>
                <button onclick="sendWhatsApp()" class="btn-text" style="color:#25D366;">‚úâÔ∏è Notify via WhatsApp</button>`;
        } else if (u.pts >= 1000) {
            statusDiv.innerHTML = `<p style="color:#f9e29c; font-size:13px;">‚úÖ <b>Level 1:</b> 5% Discount (Cost: 1000 pts)</p>`;
            actionDiv.innerHTML = `
                <button onclick="confirmRedeem(1000, '5%')" class="btn-secondary full-width">Redeem 1000 pts</button>
                <button onclick="sendWhatsApp()" class="btn-text" style="color:#25D366;">‚úâÔ∏è Notify via WhatsApp</button>`;
        } else {
            statusDiv.innerHTML = `<p style="color:#555; font-size:12px;">‚ùå 1,000 pts needed for 5%<br>‚ùå 1,500 pts needed for 10%</p>
            <button onclick="sendWhatsApp()" class="btn-text" style="color:#25D366;">‚úâÔ∏è Send Balance Update</button>`;
            actionDiv.innerHTML = ``;
        }

        document.getElementById('pHistory').innerHTML = u.history.slice().reverse().map(h => `
            <div class="history-item"><span>${h.date} <br><small>${h.type}</small></span>
            <span class="${h.amt >= 0 ? 'text-gold' : 'text-red'}">${h.amt > 0 ? '+' : ''}${h.amt.toFixed(0)}</span></div>`).join('');
        toggleModal('profileModal');
    }

    function confirmRedeem(cost, label) {
        if(confirm(`Redeem ${cost} points for a ${label} discount?`)) {
            db[activeIdx].pts -= cost;
            db[activeIdx].history.push({
                date: new Date().toLocaleDateString(), 
                type: `Used ${label} Reward`, 
                amt: -cost
            });
            render(); 
            openProfile(activeIdx); // Refresh to show remaining points
        }
    }

    function sendWhatsApp() {
        const u = db[activeIdx];
        const msg = `Hello ${u.name}! Your current balance at Sondhi System is ${u.pts.toFixed(0)} points. Visit us again soon!`;
        const url = `https://wa.me/${u.phone}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
    }

    // ... (Keep existing getTier, addCust, and processPurchase functions)
</script>
